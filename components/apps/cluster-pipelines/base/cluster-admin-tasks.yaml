apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: validate-manifests
spec:
  params:
    - name: source-dirs
      default: 
      - /source
      type: array
  resources:
    inputs:
      - name: source
        type: git
  results:
    - name: status
      description: Status can be one of ['Passed','Failed']
  steps:
    - name: process-source-repo
      image: quay.io/openshift/origin-cli:latest
      workingDir: /workspace/source
      script: |
        #!/usr/bin/env bash

        ls -al

        echo '-------\n'
        env
        echo '---------\n'
        echo Passed | tee $(results.status.path)
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: set-build-status
spec:
  params:
    - name: git-status-url
      type: string
    - name: git-revision
      type: string
    - name: build-status
      type: string
    - name: build-status-descr
      type: string
  steps:
    - name: process-source-repo
      image: quay.io/openshift/origin-cli:latest
      workingDir: /
      env:
        - name: GIT_USER
          valueFrom:
            secretKeyRef:
              name: git-credentials
              key: username
              optional: true
        - name: GIT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: git-credentials
              key: password
              optional: true
        - name: PIPELINE_RUN_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: PIPELINE_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
      script: |
        #!/usr/bin/env bash

        BASE_URL=$(oc whoami --show-console)
        TARGET_URL="${BASE_URL}/k8s/ns/${PIPELINE_NAMESPACE}/tekton.dev~v1beta1~PipelineRun/${PIPELINE_RUN_ID}"

        SOURCE="$(params.git-status-url)"
        PATTERN="{sha}"
        VALUE="$(params.git-revision)"
        GIT_API_URL="${SOURCE/$PATTERN/$VALUE}"

        echo $GIT_API_URL

        curl -H "Accept: application/vnd.github.v3+json" \
             -u "${GIT_USER}:${GIT_PASSWORD}" \
             --request POST \
             --data '{"context": "continuous-integration/tekton", "state": "$(params.build-status)", "description": "$(params.build-status-descr)", "target_url": "${TARGET_URL}"}' \
             $GIT_API_URL 